{
  "nodes": [
    {
      "id": "u1",
      "type": "Initial Query",
      "NL": "用户原始查询: 查询2022年四川省的销售数据，选择门店和销售额字段，只保留销售额大于500的记录，将销售额转为高销量/低销量类别，并与客户表连接，按门店分组统计平均销售额和订单数量，最后取前5个门店并排名。",
      "operation": {
        "type": "Input",
        "condition": [],
        "activate_edges": []
      },
      "Table": {
        "desc": "",
        "data": []
      }
    },
    {
      "id": "r1",
      "type": "Rewrite Query",
      "NL": "改写查询: 在 sales_table 中筛选 2022 年四川省的记录，选择门店和销售额，过滤销售额>500，转换为类别标签，并与 customer_orders 表连接，按门店聚合，计算平均销售额和订单数，按平均销售额排序，取前5并排名。",
      "operation": {
        "type": "Rewrite",
        "condition": [
          "sales_table",
          "customer_orders"
        ],
        "activate_edges": [
          "u1"
        ]
      },
      "Table": {
        "desc": "",
        "data": []
      }
    },
    {
      "id": "a1",
      "type": "Analysis Query",
      "NL": "分析改写: 在 sales_table 中筛选 2022 年四川省数据，选择字段 store, sales，过滤 sales>500，将销售额转换为类别标签 (高销量/低销量)，与 customer_orders 连接，按 store 分组，计算 AVG(sales), COUNT(order_id)，按 AVG(sales) 排序，取前5，使用 RANK() 排序。",
      "operation": {
        "type": "Analysis",
        "condition": [],
        "activate_edges": [
          "r1"
        ]
      },
      "Table": {
        "desc": "",
        "data": []
      }
    },
    {
      "id": "k1",
      "type": "Keyword",
      "NL": "关键词: 时间=2022年",
      "operation": {
        "type": "Keyword",
        "condition": [],
        "activate_edges": [
          "a1"
        ]
      },
      "Table": {
        "desc": "筛选 year=2022",
        "data": []
      }
    },
    {
      "id": "k2",
      "type": "Keyword",
      "NL": "关键词: 省份=四川省",
      "operation": {
        "type": "Keyword",
        "condition": [],
        "activate_edges": [
          "a1"
        ]
      },
      "Table": {
        "desc": "筛选 province='四川省'",
        "data": []
      }
    },
    {
      "id": "k3",
      "type": "Keyword",
      "NL": "关键词: 门店",
      "operation": {
        "type": "Keyword",
        "condition": [],
        "activate_edges": [
          "a1"
        ]
      },
      "Table": {
        "desc": "选择 store，用于分组",
        "data": []
      }
    },
    {
      "id": "k4",
      "type": "Keyword",
      "NL": "关键词: 销售额",
      "operation": {
        "type": "Keyword",
        "condition": [],
        "activate_edges": [
          "a1"
        ]
      },
      "Table": {
        "desc": "选择 sales，用于聚合计算",
        "data": []
      }
    },
    {
      "id": "k5",
      "type": "Keyword",
      "NL": "关键词: >500",
      "operation": {
        "type": "Keyword",
        "condition": [],
        "activate_edges": [
          "a1"
        ]
      },
      "Table": {
        "desc": "筛选 sales > 500",
        "data": []
      }
    },
    {
      "id": "k6",
      "type": "Keyword",
      "NL": "关键词: 高销量/低销量",
      "operation": {
        "type": "Keyword",
        "condition": [],
        "activate_edges": [
          "a1"
        ]
      },
      "Table": {
        "desc": "转换 CASE WHEN sales>1000 THEN '高销量' ELSE '低销量'",
        "data": []
      }
    },
    {
      "id": "k7",
      "type": "Keyword",
      "NL": "关键词: 客户表",
      "operation": {
        "type": "Keyword",
        "condition": [],
        "activate_edges": [
          "a1"
        ]
      },
      "Table": {
        "desc": "连接 customer_orders",
        "data": []
      }
    },
    {
      "id": "k8",
      "type": "Keyword",
      "NL": "关键词: 平均销售额",
      "operation": {
        "type": "Keyword",
        "condition": [],
        "activate_edges": [
          "a1"
        ]
      },
      "Table": {
        "desc": "聚合 AVG(sales)",
        "data": []
      }
    },
    {
      "id": "k9",
      "type": "Keyword",
      "NL": "关键词: 订单数量",
      "operation": {
        "type": "Keyword",
        "condition": [],
        "activate_edges": [
          "a1"
        ]
      },
      "Table": {
        "desc": "聚合 COUNT(order_id)",
        "data": []
      }
    },
    {
      "id": "k10",
      "type": "Keyword",
      "NL": "关键词: 前5",
      "operation": {
        "type": "Keyword",
        "condition": [],
        "activate_edges": [
          "a1"
        ]
      },
      "Table": {
        "desc": "限制 LIMIT 5",
        "data": []
      }
    },
    {
      "id": "k11",
      "type": "Keyword",
      "NL": "关键词: 排名",
      "operation": {
        "type": "Keyword",
        "condition": [],
        "activate_edges": [
          "a1"
        ]
      },
      "Table": {
        "desc": "窗口计算 RANK()",
        "data": []
      }
    },
    {
      "id": "step1",
      "type": "Filter",
      "NL": "筛选：2022 年四川省数据",
      "operation": {
        "type": "Filter",
        "condition": [
          "year",
          "province"
        ],
        "activate_edges": [
          "k1",
          "k2",
          "step2"
        ]
      },
      "Table": {
        "desc": "SELECT * FROM sales_table WHERE province='四川省' AND EXTRACT(YEAR FROM date)=2022;",
        "data": [
          [
            "date",
            "province",
            "store",
            "order_id",
            "sales"
          ],
          [
            "2022-01-01",
            "四川省",
            "门店A",
            "o001",
            1200
          ],
          [
            "2022-01-01",
            "四川省",
            "门店B",
            "o002",
            600
          ]
        ]
      }
    },
    {
      "id": "step2",
      "type": "Select",
      "NL": "选择字段：store, sales, order_id",
      "operation": {
        "type": "Select",
        "condition": [
          "store",
          "sales",
          "order_id"
        ],
        "activate_edges": [
          "k3",
          "k4",
          "step3"
        ]
      },
      "Table": {
        "desc": "SELECT store, sales, order_id FROM filtered_sales;",
        "data": [
          [
            "store",
            "sales",
            "order_id"
          ],
          [
            "门店A",
            1200,
            "o001"
          ],
          [
            "门店B",
            600,
            "o002"
          ]
        ]
      }
    },
    {
      "id": "step3",
      "type": "Filter",
      "NL": "筛选：sales > 500",
      "operation": {
        "type": "Filter",
        "condition": [
          "sales"
        ],
        "activate_edges": [
          "k5",
          "step4"
        ]
      },
      "Table": {
        "desc": "SELECT * FROM selected_sales WHERE sales > 500;",
        "data": [
          [
            "store",
            "sales",
            "order_id"
          ],
          [
            "门店A",
            1200,
            "o001"
          ],
          [
            "门店B",
            600,
            "o002"
          ]
        ]
      }
    },
    {
      "id": "step4",
      "type": "Transform",
      "NL": "转换销售额为类别：高销量/低销量",
      "operation": {
        "type": "Transform",
        "condition": [
          "sales"
        ],
        "activate_edges": [
          "k6",
          "step5"
        ]
      },
      "Table": {
        "desc": "SELECT *, CASE WHEN sales>1000 THEN '高销量' ELSE '低销量' END AS sales_level FROM filtered_sales;",
        "data": [
          [
            "store",
            "sales",
            "order_id",
            "sales_level"
          ],
          [
            "门店A",
            1200,
            "o001",
            "高销量"
          ],
          [
            "门店B",
            600,
            "o002",
            "低销量"
          ]
        ]
      }
    },
    {
      "id": "step5",
      "type": "Join",
      "NL": "连接 customer_orders 表（按 order_id）",
      "operation": {
        "type": "Join",
        "condition": [
          "order_id",
          "customer_id"
        ],
        "activate_edges": [
          "k7",
          "step6"
        ]
      },
      "Table": {
        "desc": "SELECT a.*, b.customer_id FROM transformed_sales a INNER JOIN customer_orders b ON a.order_id=b.order_id;",
        "data": [
          [
            "store",
            "sales",
            "order_id",
            "sales_level",
            "customer_id"
          ],
          [
            "门店A",
            1200,
            "o001",
            "高销量",
            "c101"
          ],
          [
            "门店B",
            600,
            "o002",
            "低销量",
            "c102"
          ]
        ]
      }
    },
    {
      "id": "step6",
      "type": "Aggregate",
      "NL": "按 store, sales_level 聚合：AVG(sales), COUNT(order_id)",
      "operation": {
        "type": "Aggregate",
        "condition": [
          "store",
          "sales_level",
          "sales",
          "order_id"
        ],
        "activate_edges": [
          "k8",
          "k9",
          "step7"
        ]
      },
      "Table": {
        "desc": "SELECT store, sales_level, AVG(sales) AS avg_sales, COUNT(order_id) AS order_count FROM joined_sales GROUP BY store, sales_level;",
        "data": [
          [
            "store",
            "sales_level",
            "avg_sales",
            "order_count"
          ],
          [
            "门店A",
            "高销量",
            1200,
            1
          ],
          [
            "门店B",
            "低销量",
            600,
            1
          ]
        ]
      }
    },
    {
      "id": "step7",
      "type": "Order/Limit",
      "NL": "按 avg_sales 降序排序",
      "operation": {
        "type": "Order/Limit",
        "condition": [
          "avg_sales"
        ],
        "activate_edges": [
          "step8"
        ]
      },
      "Table": {
        "desc": "SELECT * FROM aggregated_sales ORDER BY avg_sales DESC;",
        "data": [
          [
            "store",
            "sales_level",
            "avg_sales",
            "order_count"
          ],
          [
            "门店A",
            "高销量",
            1200,
            1
          ],
          [
            "门店B",
            "低销量",
            600,
            1
          ]
        ]
      }
    },
    {
      "id": "step8",
      "type": "Order/Limit",
      "NL": "取前5个门店",
      "operation": {
        "type": "Order/Limit",
        "condition": [
          "avg_sales"
        ],
        "activate_edges": [
          "k10",
          "step9"
        ]
      },
      "Table": {
        "desc": "SELECT * FROM ordered_sales LIMIT 5;",
        "data": [
          [
            "store",
            "sales_level",
            "avg_sales",
            "order_count"
          ],
          [
            "门店A",
            "高销量",
            1200,
            1
          ],
          [
            "门店B",
            "低销量",
            600,
            1
          ]
        ]
      }
    },
    {
      "id": "step9",
      "type": "Window",
      "NL": "窗口函数：按 avg_sales 排名",
      "operation": {
        "type": "Window",
        "condition": [
          "avg_sales"
        ],
        "activate_edges": [
          "k11"
        ]
      },
      "Table": {
        "desc": "SELECT *, RANK() OVER (ORDER BY avg_sales DESC) AS rank FROM limited_sales;",
        "data": [
          [
            "store",
            "sales_level",
            "avg_sales",
            "order_count",
            "rank"
          ],
          [
            "门店A",
            "高销量",
            1200,
            1,
            1
          ],
          [
            "门店B",
            "低销量",
            600,
            1,
            2
          ]
        ]
      }
    }
  ],
  "edges": [
    {
      "from": "u1",
      "to": "r1"
    },
    {
      "from": "r1",
      "to": "a1"
    },
    {
      "from": "r1",
      "to": "k1"
    },
    {
      "from": "r1",
      "to": "k2"
    },
    {
      "from": "r1",
      "to": "k3"
    },
    {
      "from": "r1",
      "to": "k4"
    },
    {
      "from": "r1",
      "to": "k5"
    },
    {
      "from": "r1",
      "to": "k6"
    },
    {
      "from": "r1",
      "to": "k7"
    },
    {
      "from": "r1",
      "to": "k8"
    },
    {
      "from": "r1",
      "to": "k9"
    },
    {
      "from": "r1",
      "to": "k10"
    },
    {
      "from": "r1",
      "to": "k11"
    },
    {
      "from": "a1",
      "to": "step1"
    },
    {
      "from": "step1",
      "to": "step2"
    },
    {
      "from": "step2",
      "to": "step3"
    },
    {
      "from": "step3",
      "to": "step4"
    },
    {
      "from": "step4",
      "to": "step5"
    },
    {
      "from": "step5",
      "to": "step6"
    },
    {
      "from": "step6",
      "to": "step7"
    },
    {
      "from": "step7",
      "to": "step8"
    },
    {
      "from": "step8",
      "to": "step9"
    }
  ]
}